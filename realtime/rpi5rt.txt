
Building real-time kernel for Raspberry Pi 5
============================================

These are the commands I used immediately after installing RaspiOS and setting my wifi password. 

The exact OS image I used was 2024-11-19-raspios-bookworm-arm64.img, which shows as kernel version 6.6.78 but if you want to use a newer version, you'll have to replace the patch file names below with the apporopriate matching version. You can find other patch files by looking around under https://mirrors.edge.kernel.org/pub/linux/kernel/projects/rt and replacing the 'wget' call with the matching file (use the one with 'patch.gz' extension).

---------------------------------------------------

sudo apt update
sudo apt upgrade
sudo reboot now

---- After reboot ----

sudo apt install bc bison flex libssl-dev make libncurses5-dev

git clone --depth=1 https://github.com/raspberrypi/linux

wget https://mirrors.edge.kernel.org/pub/linux/kernel/projects/rt/6.6/patch-6.6.78-rt52-rc1.patch.gz
cd linux
zcat ../patch-6.6.78-rt52-rc1.patch.gz | patch -p1

KERNEL=kernel_2712
make bcm2712_defconfig
make menuconfig          # General -> Preemption Model select Real Time option

# Edit the .config file to add a personalised suffix to CONFIG_LOCALVERSION (not required but helps to identify which kernel is running later)

make -j4 Image.gz modules dtbs  # takes about 40 minutes on Pi5
sudo make -j6 modules_install

sudo cp arch/arm64/boot/Image.gz /boot/firmware/kernel_2712_rt.img

sudo cp arch/arm64/boot/dts/broadcom/*.dtb /boot/firmware/
sudo cp arch/arm64/boot/dts/overlays/*.dtb* /boot/firmware/overlays/
sudo cp arch/arm64/boot/dts/overlays/README /boot/firmware/overlays/

# Edit /boot/firmware/config.txt to add "kernel=kernel_2712_rt.img" in the [all] section

sudo reboot now

---- After reboot ----

uname -a   # should show PREEMPT_RT and the kernel suffix you set

---- To save yourself enormous confusion and frustration later, prevent apt from updating any kernel components back to the standard ones like this:

sudo apt-mark hold raspberrypi-kernel

